---
title: "Longitudinal Data"
author: "Eric R. Scott"
date: "2021-06-02"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
library(lubridate)
library(patchwork)
library(lme4)
library(performance)
library(broom)
library(broom.mixed)
library(car)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
```
```{r}
#function for plotting fitted data from lmer() models
my_augment <- function(model) {
  mf <- model.frame(model)
  newdata <-  expand_grid(hist_treat = factor(levels(mf$hist_treat), levels(mf$hist_treat)),
                          curr_treat = factor(levels(mf$curr_treat), levels(mf$curr_treat)),
                          days = seq(min(mf$days), max(mf$days), length.out = 50),
                          july_herbivory_count = 0,
                          plot_id = "newlevel",
                          pot_id = "newlevel",
                          plant_id = "newlevel")
  plotdf <- augment(model, newdata = newdata, allow.new.levels = TRUE)
  return(plotdf)
}
```

*Last compiled: `r Sys.Date()`*

# Purpose

What is the goal of this notebook?

# Load Data

```{r data, echo=TRUE}
longdata <- read_rds(here("data", "clean_data", "longdata.rds"))
```

## Data Dictionary

Use `df_dict(df)` to automatically insert a template markdown data dictionary at the location of your cursor

# Analysis

Figure 2: As facets:

```{r}
ggplot(longdata, aes(x = date, y = height)) +
  stat_summary(aes(color = hist_treat, linetype = curr_treat), geom = "line", fun = "mean") +
  facet_wrap(~species, scales = "free_y", ncol = 1) +
  scale_x_datetime("Date", date_breaks = "1 week", date_labels = "%m/%d") +
  scale_y_continuous("Height (cm)") +
  scale_color_discrete("Historical") +
  scale_linetype_discrete("Current") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Growth rate

Wait, before cutting off dates, let's calculate growth rate and see how that looks.

```{r}
longdata_2 <-
  longdata %>%
  group_by(species, plant_id) %>%
  arrange(date) %>% 
  mutate(growth = height - lag(height))


ggplot(longdata_2, aes(y = growth, x = date, color = hist_treat, linetype = curr_treat)) +
  stat_summary(geom = "line", fun = "mean") +
  stat_summary(geom = "point", fun = "mean", aes(shape = hist_treat)) +
  facet_wrap(~species) +
  scale_x_datetime("", date_breaks = "1 week", date_labels = "%m/%d")
```


```{r}
ggplot(longdata_2, aes(growth)) + geom_histogram() + facet_wrap(~species)
```

Growth data is leptokurtic, so might not be better.

I think it might be best to go from after initial herbivory (ask when `july_herbivory_count` happened) to just before growth levels off for **all treatments**.
Then say, oats and beans showed logistic growth patterns, but we were only interested in the linear growth phase and in final heights.

One set of models for growth \~ curr_treat\*hist_treat + july_herbivory_count

then with final harvest data do mass \~ .
or final_height \~ .



# Determine cutoffs

Kale continues growing throughout the season, but beans and oats both stop growing after a few weeks.
I think it is reasonable to just "eyeball" the point at which they stop growing, and look at growth rates before that point (the alternative would be a logistic or changepoint model---[logistic](https://bscheng.com/2014/05/07/modeling-logistic-growth-data-in-r/) might be worth looking into).
Then, I'll calculate a daily growth to hopefully reduce heteroskedasticity and remove "week" from the model, thus simplifying it.

```{r}
#split data
beans <- longdata_2 %>% filter(species == "beans")
kale <-  longdata_2 %>% filter(species == "kale")
oats <-  longdata_2 %>% filter(species == "oats")
```

## Beans

```{r}
ggplot(beans, aes(x = date, y = height)) +
  stat_summary(aes(color = hist_treat, linetype = curr_treat), geom = "line", fun = "mean") +
  scale_x_datetime("", date_breaks = "1 week", date_labels = "%m/%d") +
  scale_y_continuous("Height (cm)") +
  scale_color_discrete("Historical") +
  scale_linetype_discrete("Current") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Looks like 7/31 would be a good cutoff.

```{r}
beans_2 <- beans %>% filter(date <= ymd("2018-07-31"))
ggplot(beans_2, aes(x = date, y = height)) +
  stat_summary(aes(color = hist_treat, linetype = curr_treat), geom = "line", fun = "mean") +
  scale_x_datetime("", date_breaks = "1 week", date_labels = "%m/%d") +
  scale_y_continuous("Height (cm)") +
  scale_color_discrete("Historical") +
  scale_linetype_discrete("Current") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Oats

```{r}
ggplot(oats, aes(x = date, y = height)) +
  stat_summary(aes(color = hist_treat, linetype = curr_treat), geom = "line", fun = "mean") +
  scale_x_datetime("", date_breaks = "1 week", date_labels = "%m/%d") +
  scale_y_continuous("Height (cm)") +
  scale_color_discrete("Historical") +
  scale_linetype_discrete("Current") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Less clear for oats---it seems like the end of growth depends on the treatment with oats in current dry conditions not really leveling off in size until the very end and in current ambient conditions growth is leveling off by 8/07.

```{r}
oats_2 <- oats %>% filter(date <= ymd("2018-08-07"))
ggplot(oats_2, aes(x = date, y = height)) +
  stat_summary(aes(color = hist_treat, linetype = curr_treat), geom = "line", fun = "mean") +
  scale_x_datetime("", date_breaks = "1 week", date_labels = "%m/%d") +
  scale_y_continuous("Height (cm)") +
  scale_color_discrete("Historical") +
  scale_linetype_discrete("Current") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



# Models

start with kale because it keeps growing the whole time

## Kale

### Height ~ days

Fit full model

```{r}
k_ht <-
  lmer(
    log(height) ~ days * hist_treat * curr_treat + july_herbivory_count +
      (1|plot_id) + (1|pot_id) + (1|plant_id), #just random intercepts
    data = kale %>% filter(!is.na(height)),
  )
```
singularity warning likely due to random effects close to 0?

```{r}
check_heteroscedasticity(k_ht)
check_model(k_ht, check = c("linearity", "qq", "normality", "homogeneity", "reqq"))
```

```{r}
Anova(k_ht)
```

days = significant growth (slope of height over time)
days:hist_treat:curr_treat = hard to interpret, especially since no main effects

```{r}
ggplot(my_augment(k_ht), aes(x = days, color = hist_treat, linetype = curr_treat)) + 
  geom_line(aes(y = .fitted)) +
  labs(y = "log(fitted height)")
```

### Growth ~

```{r}
hist(kale$growth) #leptokurtic
```

```{r}
k_gr <- 
  lmer(
    growth ~ hist_treat*curr_treat + july_herbivory_count +
      (1|plot_id) + (1|pot_id), 
    data = kale
  )
summary(k_gr) #plot ID non significant, variance = 0
```


```{r}
check_heteroscedasticity(k_gr)
check_model(k_gr, check = c("linearity", "qq", "normality", "homogeneity", "reqq"))
```

Not worried about homogeneity of variance, but kurtosis is real bad.


#### Growth with family = scat

The Scaled t family is appropriate for leptokurtic distributions, but only available in `mgcv::gam()` as far as I know. Fortunately, `gam()` can fit random effects.

```{r}
library(mgcv)
library(gratia)
k_gr_gam <-
  mgcv::gam(growth ~ hist_treat*curr_treat + july_herbivory_count +
              s(plot_id, bs = "re") + s(pot_id, bs = "re"),
      data = kale %>% filter(!is.na(growth)) %>% mutate(across(ends_with("_id"), as.factor)),
      family = scat)

AIC(k_gr_gam, k_gr)

gratia::appraise(k_gr_gam)
```

seems better, but likely overkill.


### Logistic growth

(https://bscheng.com/2014/05/07/modeling-logistic-growth-data-in-r/)

$$
y = \frac{\phi_1}{(1+e^{-(\phi_2 + \phi_3x)})}
$$
y = mass, or could be a population, or any response variable exhibiting logistic growth
phi1 = the first parameter and is the asymptote (e.g. stable adult mass)
phi2 = the second parameter and thereâ€™s not much else to say about it
phi3 = the third parameter and is also known as the growth parameter, describes how quickly y approaches the asymptote
x = the input variable, in our case, days since birth

initial parameters for nls

```{r}
library(car)
coef(lm(logit(height/100)~days, data = kale))
```


```{r}
m_logistic <- nls(height ~ phi1 / (1 + exp(-(phi2 + phi3 * days))),
 start = list(phi1 = 100, phi2 = -2.18, phi3 = .023), data = kale, trace=TRUE)
summary(m_logistic)

```

```{r}
plot(m_logistic)
```

```{r}
#set parameters
phi1 <- coef(m_logistic)[1]
phi2 <- coef(m_logistic)[2]
phi3 <- coef(m_logistic)[3]
x <-
  c(min(kale$days):max(kale$days)) #construct a range of x values bounded by the data
y <- phi1 / (1 + exp(-(phi2 + phi3 * x))) #predicted mass
predict <-
  data.frame(x, y) #create the prediction data frame#And add a nice plot (I cheated and added the awesome inset jpg in another program)
ggplot(data = kale, aes(x = days, y = height)) +
  geom_jitter(color = 'blue', alpha = 0.4) +
  scale_x_continuous() +
  scale_y_continuous() +
  geom_line(data = predict, aes(x = x, y = y))

```
Cool, but don't know how to add covariates


## Beans
Fit full model

```{r}
b_ht <-
  lmer(
    log(height) ~ days * hist_treat * curr_treat + july_herbivory_count +
      (1|plot_id) + (1|pot_id) + (1|plant_id), #random intercepts only
    data = beans_2,
  )

summary(b_ht)
```

```{r}
check_heteroscedasticity(b_ht)
check_model(b_ht,check = c("linearity", "qq", "normality", "homogeneity", "reqq"))
```

```{r}
Anova(b_ht)
```

- days = significant growth (change in height over time)
- july_herbivory_count = significant effect of herbivory on height
- days:hist_treat = different slopes (height over time) for different historical treatments

plot

```{r}
ggplot(my_augment(b_ht), aes(x = days, color = hist_treat, linetype = curr_treat)) + 
  geom_line(aes(y = .fitted)) +
  labs(y = "log(fitted height)")
```

Only significant interaction:
```{r}
my_augment(b_ht) %>% 
  group_by(hist_treat, days) %>% 
  summarize(.fitted = mean(.fitted)) %>% 
ggplot(aes(x = days, color = hist_treat)) + 
  geom_line(aes(y = .fitted)) +
  labs(y = "log(fitted height)")
```

## Oats

Fit full model

This one is better without log transformation

```{r}
o_ht <-
  lmer(
    height ~ days * hist_treat * curr_treat + july_herbivory_count +
      (1|plot_id) + (1|pot_id) + (1|plant_id), #random intercepts only
    data = oats_2,
  )

summary(o_ht)
```

```{r}
check_heteroscedasticity(o_ht)
check_model(o_ht, check = c("linearity", "qq", "normality", "homogeneity", "reqq"))
```


```{r}
Anova(o_ht)
```

- days = significant growth (change in height over time)
- july_herbivory_count = significant effect of herbivory on height
- days:curr_treat = different slopes (height over time) for different current treatments

```{r}
ggplot(my_augment(o_ht), aes(x = days, color = hist_treat, linetype = curr_treat)) + 
  geom_line(aes(y = .fitted)) +
  labs(y = "predicted height (cm)")
```
Three-way interaction probably driven by low x ambient vs low x 50%


Only current condition interaction:

```{r}
my_augment(o_ht) %>% 
  group_by(curr_treat, days) %>% 
  summarize(.fitted = mean(.fitted)) %>% 
ggplot(aes(x = days, linetype = curr_treat)) + 
  geom_line(aes(y = .fitted)) +
  labs(y = "predicted height (cm)")
```



# Change from baseline

So the other way to do this would be a change from baseline analysis---calculate change in ht for each individual plant so there is just one number, not a timeseries.  Has less statistical power because n=~200 instead of n=~3,000

```{r}
tg <- longdata_2 %>% 
  filter(!is.na(height)) %>%
  group_by(plant_id) %>% 
  arrange(plant_id, date) %>% 
  summarize(species = unique(species),
            total_growth = last(height) - first(height),
            plot_id = unique(plot_id),
            pot_id = unique(pot_id),
            curr_treat = unique(curr_treat),
            hist_treat = unique(hist_treat),
            july_herbivory_count = unique(july_herbivory_count)
            )
hist(tg$total_growth)
```

```{r}
k_tg <- lmer(total_growth ~ curr_treat*hist_treat + july_herbivory_count + (1|plot_id) + (1|pot_id),
             data = tg %>% filter(species == "kale"))
check_model(k_tg, check = c("linearity", "qq", "normality", "homogeneity", "reqq"))
```

Not great

```{r}
Anova(k_tg)
```

```{r}
b_tg <- lmer(total_growth ~ curr_treat*hist_treat + july_herbivory_count + (1|plot_id) + (1|pot_id),
             data = tg %>% filter(species == "beans"))
check_model(b_tg, check = c("linearity", "qq", "normality", "homogeneity", "reqq"))
```

```{r}
Anova(b_tg)
```


```{r}
o_tg <- lmer(total_growth ~ curr_treat*hist_treat + july_herbivory_count + (1|plot_id) + (1|pot_id),
             data = tg %>% filter(species == "oats"))
check_model(o_tg, check = c("linearity", "qq", "normality", "homogeneity", "reqq"))
```

```{r}
Anova(o_tg)
```