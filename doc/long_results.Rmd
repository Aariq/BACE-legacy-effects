---
title: "Longitudinal Data Analysis Results"
author: "Eric Scott"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## target knits Rmds in their own session, so load libraries here.
## source("../packages.R")
library(targets)
library(lme4)
library(car)
library(tidyverse)
library(emmeans)
library(broom)
library(broom.mixed)
source(here::here("R", "plot_fitted.R"))
```

```{r}
withr::with_dir(here::here(), {
  tar_load(c(
    k_ht,
    b_ht,
    o_ht,
    longdata
  ))
})
```

# Analysis

To determine the effects of the historical and current precipitation treatments on crop growth, we analyzed the effects of the treatments on change in height over time.
Because kale grows indeterminately <!--# correct terminology? -->, we used height data from the entire experiment from \_\_\_\_ to \_\_\_\_.
Oats and beans, on the other hand, switched from growth to reproduction and we only used data from the growing phase to analyze effects on height.
This was \_\_\_ to \_\_\_ for oats and \_\_\_ to \_\_\_ for beans.
We used linear mixed effects models to model height as a function of date, historical treatment, current treatment, their three-way interaction, and all two-way interactions among them.
Additionally, early herbivory incidence (mainly small mammal herbivory) and house ID were included as fixed effects.
Pot ID and plant ID were included as random effects.
For kale and beans, height was log transformed to meet model assumptions.
Height data for oats was left untransformed as the untransformed data better fit model assumptions of linearity and homogeneity of variances.
Models were fit using the `lme4` package [@batesFittingLinearMixedeffects2015].
Because we were primarily interested in the fitted slope of height as a function of date, we focused our interpretation on two- and three-way interactions with date using the `emtrends()` function from the `emmeans` package [@lenthEmmeans2021].

## Kale

Model:

```{r}
formula(k_ht)
```

```{r}
Anova(k_ht)
```

-   days = significant growth (slope of height over time)
-   days:hist_treat:curr_treat = hard to interpret, especially since no main effects

```{r}
ggplot(my_augment(k_ht), aes(x = days, color = hist_treat, linetype = curr_treat)) + 
  stat_summary(geom = "line", aes(y = .fitted)) +
  labs(y = "log(fitted height)")
```

Since the difference in the slopes is the focus, I can plot just the slopes for each line, with confidence intervals.
95% CIs are typical, but here I'm plotting 84% CIs which overlap about 95% of the time for random samples from the same population (i.e. null hypothesis) [@paytonOverlappingConfidenceIntervals2003].

```{r}
tar_read(k_slopes)
```

## Beans

```{r}
formula(b_ht)
```

```{r}
Anova(b_ht)
```

-   days = significant growth (change in height over time)
-   days:hist_treat = different slopes (height over time) for different historical treatments

plot

```{r}
ggplot(my_augment(b_ht), aes(x = days, color = hist_treat, linetype = curr_treat)) + 
  stat_summary(geom = "line", aes(y = .fitted)) +
  labs(y = "log(fitted height)")
```

Only significant interaction:

```{r}
my_augment(b_ht) %>% 
  group_by(hist_treat, days) %>% 
  summarize(.fitted = mean(.fitted)) %>% 
ggplot(aes(x = days, color = hist_treat)) + 
  geom_line(aes(y = .fitted)) +
  labs(y = "log(fitted height)")
```

Only slopes:

```{r}
tar_read(b_slopes)
```

## Oats

Here we use untransformed height as a response because the residuals of this model better met assumptions of normality and heteroskedasticity compared to log(height).

```{r}
formula(o_ht)
```

```{r}
Anova(o_ht)
```

-   days = significant growth (change in height over time)
-   july_herbivory = significant effect of herbivory on height
-   house = significant blocking effect (weeds?)
-   curr_treat = different intercepts for different treatments
-   days:curr_treat = different slopes (height over time) for different current treatments
-   days:hist_treat:curr_treat = hard to interpret, especially since no main effects

```{r}
ggplot(my_augment(o_ht), aes(x = days, color = hist_treat, linetype = curr_treat)) + 
  stat_summary(geom = "line", aes(y = .fitted)) +
  labs(y = "predicted height (cm)")
```

Three-way interaction probably driven by low x ambient vs low x 50%

Only current condition interaction:

```{r}
my_augment(o_ht) %>% 
  group_by(curr_treat, days) %>% 
  summarize(.fitted = mean(.fitted)) %>% 
ggplot(aes(x = days, linetype = curr_treat)) + 
  geom_line(aes(y = .fitted)) +
  labs(y = "predicted height (cm)")
```

Just slopes.

```{r}
tar_read(o_slopes)
```

# Publication quality figure

```{r}
tar_read(slopes_plot)
```

# References

::: {#refs}
:::

# Reproducibility

<details>

<summary>

Reproducibility receipt

</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
