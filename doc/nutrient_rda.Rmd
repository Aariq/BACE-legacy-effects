---
title: "Multivariate analysis of nutrients"
author: "Eric Scott"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
## target knits Rmds in their own session, so load libraries here.
## source("here::here(packages.R"))
library(tidyverse)
library(targets)
library(vegan)
library(RVAideMemoire)
set.seed(9872) #for reproducibility of permutation tests
```

```{r load-targets, include=FALSE}
withr::with_dir(here::here(), {
  tar_load(c(
    oat_nutr,
    bean_nutr,
    kale_nutr,
    oat_rda,
    bean_rda,
    kale_rda
  ))
})
```

# Analysis

Do historical and current treatments (and their interaction) differ in nutrient **concentration**?

Approach: redundancy analysis (RDA)

A brief description of how RDA works from @herveMultivariateAnalysisMultiple2018:

> In the multivariate framework, we consider Redundancy Analysis (RDA).
> The analysis consists of two steps.
> First we fit a multivariate linear regression between the chemical data and the controlled variables.
> Second we perform two PCAs.
> The 'constrained PCA' is applied on the fitted values of the regression and summarizes the variation of the chemical data explained by the controlled variables.
> The 'unconstrained PCA' is applied on the residuals of the regression and summarizes the variation that is not related to the controlled variables.

**NOTE**
`jul_herbivory` is cumulative herbivory in July, which was small-mammal herbivory.  `late_herbivory` is the cumulative herbivory in August minus cumulative herbivory in July.  Late herbivory was insect herbivory.  So `jul_herbivory` is small mammal herbivory and `late_herbivory` is just the insect herbivory.

## Oats

```{r}
# oat_rda <-
#   rda(
#     oat_nutr["nutr"] ~ historical * current + jul_herbivory + late_herbivory,
#     data = oat_nutr,
#     scale = FALSE #already scaled and centered
#   )
```

Formula:

```{r}
oat_rda$call
```


```{r}
MVA.synt(oat_rda)
```

The experimental design (current treatment, historical treatment, their interaction, and herbivory) explain \~34% of variation in nutrients.
The first two constrained axes capture \~83% of *that* variance. So, about `r round(.8256*.3388*100, 2)`% of the constrained variance are explained by the first two axes 

### Permutation Test

Using permutation tests means we don't need to worry much about the multivariate normality of the nutrient data.

**Overall Effect**

Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of experimental design.

```{r}
anova(oat_rda)
```

The model does explain a significant proportion of variance.  Now we can do a marginal hypothesis test (type II ANOVA)

```{r}
MVA.anova(oat_rda)
```

Current treatment and early (small mammal) herbivory significantly affect nutrients in oats.

### Plots

```{r}
MVA.plot(
  oat_rda,
  "score",
  fac = oat_nutr$current,
  col = c("blue", "darkgreen", "brown"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "Current Treatment",
  xlim = c(-5, 5)
)
MVA.plot(
  oat_rda,
  "score",
  fac = oat_nutr$jul_herbivory,
  col = c("black", "red"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "July Herbivory",
  xlim = c(-5, 5)
)
MVA.plot(
  oat_rda,
  "corr",
  add = FALSE,
  # intcircle = NULL,
  # thresh = 0.5
)
```

Axis 1 is positively correlated with Mn, B, and Ca and negatively correlated with P, K, Cu, Zn, Fe.  Axis 2 is positively correlated with N and negatively correlated with Al.

```{r}
library(ggpubr)
```


```{r}
#extract scores
oat_scores <- MVA.scores(oat_rda)
#combine with experimental treatments
oat_score_df <- bind_cols(oat_nutr, oat_scores$coord)
```

With convex hulls for herbivory

```{r}
ggplot(oat_score_df, aes(x = `Constr. comp. 1`, y = `Constr. comp. 2`,
                         fill = jul_herbivory,
                         color = jul_herbivory,
                         linetype = jul_herbivory)) +
  stat_chull(geom = "polygon", alpha = 0.4, color = "black") +
  geom_point(aes(shape = current), color = "black") +
  theme_bw() +
  theme(panel.grid= element_blank())
```

With convex hulls for current treatment

```{r}
ggplot(oat_score_df, aes(x = `Constr. comp. 1`, y = `Constr. comp. 2`,
                         fill = current,
                         color = current,
                         linetype = current)) +
  stat_chull(geom = "polygon", alpha = 0.4, color = "black") +
  geom_point(aes(shape = jul_herbivory), color = "black") +
  theme_bw() +
  theme(panel.grid= element_blank())
```

What is that big divide?
```{r}
oat_score_df %>% filter(`Constr. comp. 1` < 0) %>% filter(jul_herbivory == "some") %>% count(plot)
oat_score_df %>% filter(`Constr. comp. 1` > 0) %>% count(plot)
```


## Beans

```{r}
# bean_rda <-
#   rda(
#     bean_nutr["nutr"] ~ historical * current + jul_herbivory + late_herbivory,
#     data = bean_nutr,
#     scale = FALSE
#   )
```

Formula:

```{r}
bean_rda$call
```


```{r}
MVA.synt(bean_rda)
```

\~33% of variation explained by "experiment"


### Permutation Test

```{r}
anova(bean_rda)
```

```{r}
MVA.anova(bean_rda)
```

current treatment and july herbivory significantly affect nutrients.

### Plots

```{r}
MVA.plot(
  bean_rda,
  "score",
  fac = bean_nutr$current,
  col = c("blue", "darkgreen", "brown"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "current",
  xlim = c(-5, 5)
)
MVA.plot(
  bean_rda,
  "score",
  fac = bean_nutr$jul_herbivory,
  col = c("black", "red"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "July Herbivory",
  xlim = c(-5, 5)
)
MVA.plot(
  bean_rda,
  "corr",
  add = FALSE,
  # intcircle = NULL,
  # thresh = 0.5
)
```

Axis 1 is positively correlated with mn and negatively correlated with Zn, K, P, and N.  Axis 2 negatively correlated with N.

## Kale

```{r}
# kale_rda <-
#   rda(
#     kale_nutr["nutr"] ~ historical * current + jul_herbivory + late_herbivory,
#     data = kale_nutr,
#     scale = TRUE
#   )
```

Formula:

```{r}
kale_rda$call
```


```{r}
MVA.synt(kale_rda)
```

\~30% of variance explained by "experiment"

### Permutation Test

```{r}
anova(kale_rda)
```

```{r}
MVA.anova(kale_rda)
```

historical and current conditions affect nutrition.
Early herbivory is also significant

### Plots

```{r}
MVA.plot(
  kale_rda,
  "score",
  fac = kale_nutr$historical,
  col = c("blue", "darkgreen", "brown"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "historical",
  xlim = c(-5, 5)
)
MVA.plot(
  kale_rda,
  "score",
  fac = kale_nutr$current,
  col = c("blue", "darkgreen", "brown"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "current",
  xlim = c(-5, 5)
)
MVA.plot(
  kale_rda,
  "score",
  fac = kale_nutr$jul_herbivory,
  col = c("black", "red"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "July Herbivory",
  xlim = c(-5, 5)
)
MVA.plot(
  kale_rda,
  "corr",
  add = FALSE,
  # intcircle = NULL,
  # thresh = 0.5
)
```

Axis 1 = more nutrition to less nutrition, separates along historical from high, low, medium Axis 2 = high in zn and n to high in p, cu, mn.
separates current from 75%, 50%, ambient.

# References

<div id="refs"></div>

# Reproducibility

<details>

<summary>

Reproducibility receipt

</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
