---
title: "Multivariate analysis of nutrients"
author: "Eric Scott"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
## target knits Rmds in their own session, so load libraries here.
## source("here::here(packages.R"))
library(tidyverse)
library(targets)
library(vegan)
library(RVAideMemoire)
```

```{r load-targets, include=FALSE}
withr::with_dir(here::here(), {
  tar_load(c(
    oat_nutr,
    bean_nutr,
    kale_nutr
  ))
})
```

# Analysis

Do historical and current treatments (and their interaction) differ in nutrient **concentration**?

Approach: redundancy analysis

**NOTE** Currently `aug_cum_herbivory` *includes* `jul_herbivory`.
That is, it represents cumulative herbivory by august.
It would be ideal to separate early herbivory (small mammals) from late herbivory (insects) and include both.
For now I'll just use `jul_herbivory`.

`*_herbivory` is a categorical variable that is "some" if any of the plants experienced any amount of herbivory.
`*_herbivory_mean` is a numeric pot-level average of herbivory events (for `jul_herbivory_mean`, at least).
`aug_cum_herbivory_mean` is taken directly from the raw data, and I'm not sure how the pot-level means were calculated.

A brief description of how RDA works from @herveMultivariateAnalysisMultiple2018:

> In the multivariate framework, we consider Redundancy Analysis (RDA).
> The analysis consists of two steps.
> First we fit a multivariate linear regression between the chemical data and the controlled variables.
> Second we perform two PCAs.
> The 'constrained PCA' is applied on the fitted values of the regression and summarizes the variation of the chemical data explained by the controlled variables.
> The 'unconstrained PCA' is applied on the residuals of the regression and summarizes the variation that is not related to the controlled variables.

## Oats

```{r}
nutr <- as.matrix(select(oat_nutr, c(n, ca, k, mg, p, al, b, cu, fe, mn, zn)))
oat_rda <-
  rda(
    nutr ~ historical * current + jul_herbivory,
    data = oat_nutr,
    scale = TRUE
  )
```

```{r}
MVA.synt(oat_rda)
```

The experimental design (current treatment, historical treatment, their interaction, and herbivory) explain \~20% of variation in nutrients.
The first constrained axis captures \~62% of *that* variance.

### Permutation Test

Using permutation tests means we don't need to worry much about the multivariate normality of the nutrient data.

**Overall Effect**

Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of experimental design.

```{r}
anova(oat_rda)
```

The model does not explain significantly more variance in nutrients than a null model.
I think we should probably stop here.
If this test *were* significant, we could do a marginal hypothesis test for effects of each predictor (type II ANOVA):

```{r}
MVA.anova(oat_rda)
```

But I don't think it's appropriate to trust these results since the `anova()` was non-significant.

If we use cumulative herbivory in August, it is significant though.
Would be good to have separate columns for early and late herbivory.

```{r}
oat_rda2 <-
  rda(
    nutr ~ historical * current + aug_cum_herbivory,
    data = oat_nutr,
    scale = TRUE
  )
anova(oat_rda2)
```

### Plots

```{r}
MVA.plot(
  oat_rda,
  "score",
  fac = oat_nutr$current,
  col = c("blue", "darkgreen", "brown"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "current",
  xlim = c(-5, 5)
)

MVA.plot(
  oat_rda,
  "corr",
  add = FALSE,
  # intcircle = NULL,
  # thresh = 0.5
)
```

I suspect the division is more related to *late* herbivory.
I bet if we added this to the model, it would be significant.

```{r}
MVA.plot(
  oat_rda,
  "score",
  fac = oat_nutr$aug_cum_herbivory,
  col = c("black", "red"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "Aug. cumulative herbivory",
  xlim = c(-5, 5)
)
```

## Beans

```{r}
nutr <- as.matrix(select(bean_nutr, c(n, ca, k, mg, p, al, b, cu, fe, mn, zn)))
bean_rda <-
  rda(
    nutr ~ historical * current + jul_herbivory,
    data = bean_nutr,
    scale = TRUE
  )
```

```{r}
MVA.synt(bean_rda)
```

\~28% of variation explained by "experiment"

### Overall ANOVA

```{r}
anova(bean_rda)
```

### Permutation Test

```{r}
MVA.anova(bean_rda)
```

current conditions and july herbivory significantly affect nutrients.

### Plots

```{r}
MVA.plot(
  bean_rda,
  "score",
  fac = bean_nutr$current,
  col = c("blue", "darkgreen", "brown"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "current",
  xlim = c(-5, 5)
)
MVA.plot(
  bean_rda,
  "score",
  fac = bean_nutr$jul_herbivory,
  col = c("black", "red"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "July Herbivory",
  xlim = c(-5, 5)
)
MVA.plot(
  bean_rda,
  "corr",
  add = FALSE,
  # intcircle = NULL,
  # thresh = 0.5
)
```

## Kale

```{r}
nutr <- as.matrix(select(kale_nutr, c(n, ca, k, mg, p, al, b, cu, fe, mn, zn)))
kale_rda <-
  rda(
    nutr ~ historical * current  + jul_herbivory,
    data = kale_nutr,
    scale = TRUE
  )
```

```{r}
MVA.synt(kale_rda)
```

\~28% of variance explained by "experiment"

### Permutation Test

```{r}
anova(kale_rda)
```

```{r}
MVA.anova(kale_rda)
```

historical and current conditions affect nutrition.
Herbivory is also significant

### Plots

```{r}
MVA.plot(
  kale_rda,
  "score",
  fac = kale_nutr$historical,
  col = c("blue", "darkgreen", "brown"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "historical",
  xlim = c(-5, 5)
)
MVA.plot(
  kale_rda,
  "score",
  fac = kale_nutr$current,
  col = c("blue", "darkgreen", "brown"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "current",
  xlim = c(-5, 5)
)
MVA.plot(
  kale_rda,
  "score",
  fac = kale_nutr$jul_herbivory,
  col = c("black", "red"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "July Herbivory",
  xlim = c(-5, 5)
)
MVA.plot(
  kale_rda,
  "corr",
  add = FALSE,
  # intcircle = NULL,
  # thresh = 0.5
)
```

Axis 1 = more nutrition to less nutrition, separates along historical from high, low, medium Axis 2 = high in zn and n to high in p, cu, mn.
separates current from 75%, 50%, ambient.

# References

<div id="refs"></div>

# Reproducibility

<details>

<summary>

Reproducibility receipt

</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
