---
title: "Multivariate analysis of nutrients"
author: "Eric Scott"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
## target knits Rmds in their own session, so load libraries here.
## source("here::here(packages.R"))
library(tidyverse)
library(targets)
library(vegan)
library(RVAideMemoire)
library(ggpubr)
library(ggrepel)
library(ggpmisc)
set.seed(9872) #for reproducibility of permutation tests
```

```{r load-targets, include=FALSE}
withr::with_dir(here::here(), {
  tar_load(c(
    oat_nutr,
    bean_nutr,
    kale_nutr,
    oat_rda,
    bean_rda,
    kale_rda
  ))
})
```

# Analysis

Do historical and current treatments (and their interaction) differ in nutrient **concentration**?

Approach: redundancy analysis (RDA)

A brief description of how RDA works from @herveMultivariateAnalysisMultiple2018:

> In the multivariate framework, we consider Redundancy Analysis (RDA).
> The analysis consists of two steps.
> First we fit a multivariate linear regression between the chemical data and the controlled variables.
> Second we perform two PCAs.
> The 'constrained PCA' is applied on the fitted values of the regression and summarizes the variation of the chemical data explained by the controlled variables.
> The 'unconstrained PCA' is applied on the residuals of the regression and summarizes the variation that is not related to the controlled variables.

**NOTE**
`jul_herbivory` is cumulative herbivory in July, which was small-mammal herbivory.  `late_herbivory` is the cumulative herbivory in August minus cumulative herbivory in July.  Late herbivory was insect herbivory.  So `jul_herbivory` is small mammal herbivory and `late_herbivory` is just the insect herbivory.

## Oats
Formula:

```{r}
oat_rda$call
```


```{r}
MVA.synt(oat_rda)
```

Conditional = % variation explained by `house`
Constrained = % variation explained by predictor variables
Unconstrained = remaining variation

### Permutation Test

Using permutation tests means we don't need to worry much about the multivariate normality of the nutrient data.

**Overall Effect**

Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of experimental design.

```{r}
anova(oat_rda)
```

The model does explain a significant proportion of variance.  Now we can do a marginal hypothesis test (type II ANOVA)

```{r}
MVA.anova(oat_rda)
```

Current treatment significantly affect nutrients in oats.  `late_herbivory` is marginally significant

### Plots

```{r}
#extract scores
oat_scores <- MVA.scores(oat_rda, xax = 1, yax = 2)
#combine with experimental treatments
oat_score_df <- bind_cols(oat_nutr, oat_scores$coord)
```

```{r}
#extract correlations
oat_cor_df <-
  MVA.cor(oat_rda)$corr %>% 
  as_tibble(rownames = "nutrient") %>% 
  #format nutrients for plotting
  mutate(nutrient = str_extract(nutrient, "(?<=nutr\\.)\\w{1,2}(?=_scaled)")) %>% 
  mutate(nutrient = str_to_title(nutrient)) %>% 
  #math to put labels at tips of arrows
  mutate(m = `Constr. comp. 2`/`Constr. comp. 1`,
         xplus = sqrt(1 / (1 + m^2)),
         yplus = abs(m * xplus)) %>% 
  mutate(xplus = ifelse(sign(`Constr. comp. 1`) == -1, xplus*-1, xplus),
         yplus = ifelse(sign(`Constr. comp. 2`) == -1, yplus*-1, yplus))
```

```{r}
# threshold of correlation
thresh = 0.5
oat_cor_df <- oat_cor_df %>% 
  mutate(thresh = abs(`Constr. comp. 1`) > thresh | abs(`Constr. comp. 2`) > thresh)
```


With convex hulls for current treatment

```{r}
ggplot(oat_score_df, aes(x = `Constr. comp. 1`, y = `Constr. comp. 2`,
                         fill = current,
                         color = current,
                         linetype = current)) +
  # Plot points and convex hull
  stat_chull(geom = "polygon", alpha = 0.4, color = "black") +
  geom_point(aes(shape = historical), color = "black", size = 2, stroke = 0.75) +
  # Scales and legends
  scale_fill_viridis_d("Current", begin = 0.33) +
  scale_linetype_manual("Current", values = c("solid", "longdash", "dotted")) +
  scale_shape_discrete("Historical", solid = FALSE) +
  guides(fill = guide_legend(override.aes = list(shape = NA))) +
  scale_x_continuous(
    glue::glue("Constrained comp. 1 ({MVA.synt(oat_rda)[[2]]$tab[1,2] %>% round(2)}%)"),
    limits = symmetric_limits
  ) +
  scale_y_continuous(
    glue::glue("Constrained comp. 2 ({MVA.synt(oat_rda)[[2]]$tab[2,2] %>% round(2)}%)"),
    limits = symmetric_limits
  ) +
  # Theme
  theme_bw() +
  theme(panel.grid= element_blank())
  
```

```{r}
ggplot(oat_cor_df) +
  geom_segment(aes(
    x = 0,
    y = 0,
    xend = `Constr. comp. 1`,
    yend = `Constr. comp. 2`,
    alpha = thresh
  ),
               arrow = arrow(length = unit(0.02, "npc"))) +
  geom_label_repel(
    aes(x = `Constr. comp. 1`,
        y = `Constr. comp. 2`,
        label = nutrient),
    size = 2.4,
    segment.alpha = 0.6,
    segment.size = 0.3,
    nudge_x = oat_cor_df$xplus * .01,
    nudge_y = oat_cor_df$yplus * .01,
    seed = 678
  ) +
  scale_alpha_manual(values = c(0.5, 1)) +
  scale_x_continuous(
    glue::glue("Constrained comp. 1 ({MVA.synt(oat_rda)[[2]]$tab[1,2] %>% round(2)}%)"),
    limits = symmetric_limits
  ) +
  scale_y_continuous(
    glue::glue("Constrained comp. 2 ({MVA.synt(oat_rda)[[2]]$tab[2,2] %>% round(2)}%)"),
    limits = symmetric_limits
  ) +
  # Theme
  theme_bw() +
  theme(panel.grid= element_blank(), legend.position = "none")
```

```{r}
MVA.corplot(oat_rda)
# View(MVA.corplot)
```

## Beans

```{r}
# bean_rda <-
#   rda(
#     bean_nutr["nutr"] ~ historical * current + jul_herbivory + late_herbivory,
#     data = bean_nutr,
#     scale = FALSE
#   )
```

Formula:

```{r}
bean_rda$call
```


```{r}
MVA.synt(bean_rda)
```

\~33% of variation explained by "experiment"


### Permutation Test

```{r}
anova(bean_rda)
```

```{r}
MVA.anova(bean_rda)
```

current treatment and july herbivory significantly affect nutrients.

### Plots

```{r}
MVA.plot(
  bean_rda,
  "score",
  fac = bean_nutr$current,
  col = c("blue", "darkgreen", "brown"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "current",
  xlim = c(-5, 5)
)
MVA.plot(
  bean_rda,
  "score",
  fac = bean_nutr$jul_herbivory,
  col = c("black", "red"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "July Herbivory",
  xlim = c(-5, 5)
)
MVA.plot(
  bean_rda,
  "corr",
  add = FALSE,
  # intcircle = NULL,
  # thresh = 0.5
)
```

Axis 1 is positively correlated with mn and negatively correlated with Zn, K, P, and N.  Axis 2 negatively correlated with N.

## Kale

```{r}
# kale_rda <-
#   rda(
#     kale_nutr["nutr"] ~ historical * current + jul_herbivory + late_herbivory,
#     data = kale_nutr,
#     scale = TRUE
#   )
```

Formula:

```{r}
kale_rda$call
```


```{r}
MVA.synt(kale_rda)
```

\~30% of variance explained by "experiment"

### Permutation Test

```{r}
anova(kale_rda)
```

```{r}
MVA.anova(kale_rda)
```

historical and current conditions affect nutrition.
Early herbivory is also significant

### Plots

```{r}
MVA.plot(
  kale_rda,
  "score",
  fac = kale_nutr$historical,
  col = c("blue", "darkgreen", "brown"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "historical",
  xlim = c(-5, 5)
)
MVA.plot(
  kale_rda,
  "score",
  fac = kale_nutr$current,
  col = c("blue", "darkgreen", "brown"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "current",
  xlim = c(-5, 5)
)
MVA.plot(
  kale_rda,
  "score",
  fac = kale_nutr$jul_herbivory,
  col = c("black", "red"),
  legend = TRUE,
  barycenters = FALSE,
  stars = FALSE,
  contours = TRUE,
  legend.title = "July Herbivory",
  xlim = c(-5, 5)
)
MVA.plot(
  kale_rda,
  "corr",
  add = FALSE,
  # intcircle = NULL,
  # thresh = 0.5
)
```

Axis 1 = more nutrition to less nutrition, separates along historical from high, low, medium Axis 2 = high in zn and n to high in p, cu, mn.
separates current from 75%, 50%, ambient.

# References

<div id="refs"></div>

# Reproducibility

<details>

<summary>

Reproducibility receipt

</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
