---
title: "Multivariate analysis of nutrients"
author: "Eric Scott"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
## target knits Rmds in their own session, so load libraries here.
## source("here::here(packages.R"))
library(tidyverse)
library(targets)
library(vegan)
library(RVAideMemoire)
library(ggpubr)
library(ggrepel)
library(ggpmisc)
library(car)
library(conflicted)
conflict_prefer("filter", "dplyr")
set.seed(9872) #for reproducibility of permutation tests
```

```{r load-targets, include=FALSE}
withr::with_dir(here::here(), {
  tar_load(c(
    oat_nutr,
    bean_nutr,
    kale_nutr,
    oat_rda,
    bean_rda,
    kale_rda,
    oat_score,
    oat_cor,
    bean_score,
    bean_cor,
    kale_score,
    kale_cor
  ))
})
```

# Analysis

Do historical and current treatments (and their interaction) differ in nutrient **concentration**?

Approach: redundancy analysis (RDA)

A brief description of how RDA works from @herveMultivariateAnalysisMultiple2018:

> In the multivariate framework, we consider Redundancy Analysis (RDA).
> The analysis consists of two steps.
> First we fit a multivariate linear regression between the chemical data and the controlled variables.
> Second we perform two PCAs.
> The 'constrained PCA' is applied on the fitted values of the regression and summarizes the variation of the chemical data explained by the controlled variables.
> The 'unconstrained PCA' is applied on the residuals of the regression and summarizes the variation that is not related to the controlled variables.

**NOTE** `jul_herbivory` is cumulative herbivory in July, which was small-mammal herbivory.
`late_herbivory` is the cumulative herbivory in August minus cumulative herbivory in July.
Late herbivory was insect herbivory.
So `jul_herbivory` is small mammal herbivory and `late_herbivory` is just the insect herbivory.

## Methods

To understand how current and historical precipitation treatments affected crop nutrients we used partial redundancy analysis (partial RDA), a supervised multivariate technique (CITATION).
Variation explained by the blocking effect of house was accounted for ("partialed out") before modeling the effects of historical treatment, current treatment, their interaction, early herbivory (small mammal), and late herbivory (arthropods) on crop nutrients.
RDA was performed with the `rda` function from the `vegan` package [@oksanenVeganCommunityEcology2020].
RDA significance was determined with permutation tests performed using the `RVAideMemoire` package [@herveRVAideMemoireTestingPlotting2021].
Score plots and correlation plots were produced using packages `ggplot2` [@wickhamGgplot2ElegantGraphics2016], `ggrepel` [@slowikowskiGgrepelAutomaticallyPosition2021], and `ggpubr` [@kassambaraGgpubrGgplot2Based2020].

## Oats

Formula:

```{r}
oat_rda$call
```

```{r}
MVA.synt(oat_rda)
```

Conditional = % variation explained by `house` Constrained = % variation explained by predictor variables Unconstrained = remaining variation

### Permutation Test

Using permutation tests means we don't need to worry much about the multivariate normality of the nutrient data.

**Overall Effect**

Test for significance that this amount of explained variance is higher than the null hypothesis of no effect of experimental design.

```{r}
anova(oat_rda)
```

The model does explain a significant proportion of variance.
Now we can do a marginal hypothesis test (type II ANOVA)

```{r}
MVA.anova(oat_rda)
```

Current treatment significantly affect nutrients in oats.
`late_herbivory` is marginally significant

### Plots

```{r}
oat_score
```

```{r}
oat_cor
```

### ANOVAs for Fe, N, Zn

Log transformed to better meet assumptions of normality of residuals.

```{r}
oat_fe <- 
  lm(log(fe) ~ historical * current + jul_herbivory + late_herbivory + house,
       data = oat_nutr)
# performance::check_model(oat_fe)
Anova(oat_fe)
```

```{r}
oat_n <-
  lm(log(n) ~ historical * current + jul_herbivory + late_herbivory + house,
       data = oat_nutr)
# performance::check_model(oat_n)
Anova(oat_n)
```

```{r}
oat_zn <-
  lm(log(zn) ~ historical * current + jul_herbivory + late_herbivory + house,
       data = oat_nutr)
# performance::check_model(oat_zn)
Anova(oat_zn)
```

## Beans

Formula:

```{r}
bean_rda$call
```

```{r}
MVA.synt(bean_rda)
```

\~33% of variation explained by "experiment"

### Permutation Test

```{r}
anova(bean_rda)
```

```{r}
MVA.anova(bean_rda)
```

current treatment and july herbivory significantly affect nutrients.

### Plots

```{r}
bean_score
```

```{r}
bean_cor
```

### ANOVAs for Fe, N, Zn

Log transformed to better meet assumptions of normality of residuals.

```{r}
bean_fe <- 
  lm(log(fe) ~ historical * current + jul_herbivory + late_herbivory + house,
       data = bean_nutr)
# performance::check_model(bean_fe)
Anova(bean_fe)
```

```{r}
bean_n <-
  lm(log(n) ~ historical * current + jul_herbivory + late_herbivory + house,
       data = bean_nutr)
# performance::check_model(bean_n)
Anova(bean_n)
```

```{r}
bean_zn <-
  lm(log(zn) ~ historical * current + jul_herbivory + late_herbivory + house,
       data = bean_nutr)
# performance::check_model(bean_zn)
Anova(bean_zn)
```


## Kale

Formula:

```{r}
kale_rda$call
```

```{r}
MVA.synt(kale_rda)
```

\~30% of variance explained by "experiment"

### Permutation Test

```{r}
anova(kale_rda)
```

```{r}
MVA.anova(kale_rda)
```

historical and current conditions affect nutrition.
Early herbivory is also significant

### Plots

But the treatments aren't fully separated by the first two axes, but the mean plant, if you will, in 50% current treatment has more nutrients than ambient and 75%

```{r}
kale_score
```

```{r}
kale_cor
```

### ANOVAs for Fe, N, Zn

Log transformed to better meet assumptions of normality of residuals.

```{r}
kale_fe <- 
  lm(log(fe) ~ historical * current + jul_herbivory + late_herbivory + house,
       data = kale_nutr)
# performance::check_model(kale_fe)
Anova(kale_fe)
```

```{r}
kale_n <-
  lm(log(n) ~ historical * current + jul_herbivory + late_herbivory + house,
       data = kale_nutr)
# performance::check_model(kale_n)
Anova(kale_n)
```

```{r}
kale_zn <-
  lm(log(zn) ~ historical * current + jul_herbivory + late_herbivory + house,
       data = kale_nutr)
# performance::check_model(kale_zn)
Anova(kale_zn)
```

# Publication Quality Figure

```{r fig.height=9, fig.width=8}
library(patchwork)
rda_mult <- 
  kale_cor + kale_score +
  bean_cor + bean_score +
  oat_cor  + oat_score  +
  plot_layout(ncol = 2, guides = "collect") & 
  plot_annotation(tag_level = "a")
 
 ggsave(here::here("doc", "figs", "RDA.png"), rda_mult, height = 9, width = 8)
 ggsave(here::here("doc", "figs", "RDA.pdf"), rda_mult, height = 9, width = 8)
```

# References

::: {#refs}
:::

# Reproducibility

<details>

<summary>

Reproducibility receipt

</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
