---
title: "Wrangling data"
author: "Eric R. Scott"
date: "2021-05-23"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(here)
library(janitor)
library(pointblank)
library(conflicted)
library(lubridate)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# Purpose

Wrangle and validate data

Unique ID's seem to be constructed like <plot>-<historic treatment>-<species><pot>-\<replicate, omitted for summary stats\>

# Longitudinal Data

```{r data, echo=TRUE}
longdata_raw <- read_excel(here("data", "longdata.xlsx"), na = c(".", "*"))
longdata <- 
  longdata_raw %>%
  slice(-1) %>% 
  select(-"...10") %>% 
  clean_names()
```

```{r}
longdata_2 <-
  longdata %>%
  mutate(july_herbivory_count = as.integer(july_herbivory_count),
         height = as.double(height),
         across(c(plant_species, plot, curr_treat, hist_treat, pot, plant), as.factor)) %>% 
  rename(date = week) %>% 
  #days since start date
  mutate(days = (date - min(date)) %>% as.period() %>% day())
```

recode variables.  For historical treatment, 0 = high moisture, 25 = medium moisture, 50 = low moisture.  For current conditions 0 = ambient, 25 (really, -25%) = 75%, and 50 = 50%
```{r}
longdata_done <-
  longdata_2 %>% 
  mutate(plant_species = fct_recode(plant_species, kale = "k", beans = "b", oats = "o")) %>% 
  mutate(curr_treat = fct_recode(curr_treat, "ambient" = "0", "75%" = "25", "50%" = "50"),
         hist_treat = fct_recode(hist_treat, "high" = "0", "medium" = "25", "low" = "50")) %>% 
  mutate(plant_id = glue::glue("{plant_species}_plot{plot}_{hist_treat}_pot{pot}_{plant}"))

# longdata_done %>% count(plant_id)
```



```{r}
write_rds(longdata_done, here("data", "clean_data", "longdata.rds"))
```


## Mid-season Harvest

This excel workbook has hidden tabs and formulas.
I'm going to mostly trust them and go with the tabs that were shown rather than re-calculating things for now.
Tempting though...

```{r}
july_ht <- read_excel(here("data", "July_harvest_5_13_2021.xlsx")) %>% clean_names()
july_ht
```

```{r}
sheets <- c("Oatjulyharvest", "Kalejulyharvest", "Beanjulyharvest")

july_harvest_raw <- 
  map_df(sheets, ~{
    read_excel(here("data", "July_harvest_5_13_2021.xlsx"), sheet = .x) %>% 
      clean_names()
  }) %>%
  select(-pot, -height, -herb) #just get these from the other sheet.

july_harvest <-
  right_join(july_ht, july_harvest_raw) %>% 
    mutate(species = tolower(str_extract(pot, "^."))) %>% 
    select(id, species, hist, curr, plot, pot, everything())
july_harvest
```

```{r}
#plants that didn't get harvested I guess??
anti_join(july_ht, july_harvest) %>% pull(id) %>% unique()
```

# Final Harvest

This has the plant nutrient data.
This workbook also has a bunch of hidden sheets.
Gonna trust the formulas for now at least and just go with the three unhidden ones.

Can't just force numeric because of entries with inequalities like "\<4.49".
Read as chr, strip the less than.
For now, I'll just ignore that they are less than LOQ or whatever.
I think that's actually safe to do and I have a paper to cite about it.

```{r}
oats_harvest_raw <- 
  read_excel(here("data", "three_period_data_5_13_2021.xlsx"), sheet = "Oats(pot)")

oats_harvest <-
  oats_harvest_raw %>% 
  clean_names() %>% 
  slice(-1) %>%  #remove row with units
  mutate(across(n:zn, ~str_remove(.x, "<"))) %>% 
  mutate(across(n:grainharvest, ~as.numeric(.x)))
```

Repeat for beans and kale

rowbind the three with species as .id

## Data Dictionary

`longdata`: "Longdata" is the longitudinal data collected across the season.

-   `plant_species` (factor): k = kale, o = oats, b = beans
-   `plot` (factor):
-   `curr_treat` (factor): Current drought treatment
-   `hist_treat` (factor): Historic drought treatment
-   `pot` (factor):
-   `plant` (factor):
-   `week` (c("POSIXct", "POSIXt")):
-   `height` (numeric): plant height in cm
-   `july_herbivory_count` (integer): number of herbivory events during the first few weeks
